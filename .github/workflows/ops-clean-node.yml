name: OPS - Clean Node (Safe)

on:
  workflow_dispatch:
    inputs:
      target:
        description: "Which runner?"
        required: true
        type: choice
        options:
          - sg-arm
          - sg-x86
      apply:
        description: "Actually apply destructive actions?"
        required: true
        type: boolean
        default: false
      docker_volumes:
        description: "Also prune Docker volumes?"
        required: true
        type: boolean
        default: true
      clean_web:
        description: "Backup+remove common web dirs?"
        required: true
        type: boolean
        default: false

jobs:
  clean:
    # 这里先用“自定义 label”来精准命中节点（下一步 runner 绑定我会让你加 label）
    runs-on: [self-hosted, linux, "${{ inputs.target }}"]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run cleaner (dry-run or apply)
        shell: bash
        run: |
          set -euo pipefail
          chmod +x scripts/clean_node.sh

          export CLEAN_SERVICES=1
          export CLEAN_DOCKER_ALL=1
          export CLEAN_DOCKER_VOLUMES=${{ inputs.docker_volumes && '1' || '0' }}
          export CLEAN_APT=1
          export CLEAN_JOURNAL=1
          export CLEAN_WEB=${{ inputs.clean_web && '1' || '0' }}

          if [[ "${{ inputs.apply }}" == "true" ]]; then
            export CLEAN_APPLY=1
            export CONFIRM="I_UNDERSTAND"
          fi
          
          sudo -n bash -c "APPLY='${{ inputs.apply }}' PRUNE_VOLUMES='${{ inputs.docker_volumes }}' CLEAN_WEB='${{ inputs.clean_web }}' /usr/local/sbin/hz-clean-node"
