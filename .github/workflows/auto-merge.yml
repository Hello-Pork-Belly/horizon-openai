name: T-001 Auto-merge Enabler

on:
  pull_request_target:
    types: [labeled]

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: auto-merge-${{ github.repository }}-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  enable-auto-merge:
    if: >-
      ${{
        github.event.label.name == 'automerge' &&
        github.event.pull_request.state == 'open'
      }}
    runs-on: ubuntu-latest

    steps:
      - name: Gatekeeper (association + write permission)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail

          assoc="${{ github.event.sender.association }}"
          actor="${{ github.actor }}"
          repo="${{ github.repository }}"

          case "${assoc}" in
            OWNER|MEMBER|COLLABORATOR) ;;
            *)
              echo "DENY: sender.association='${assoc}' actor='${actor}'"
              exit 1
              ;;
          esac

          perm="$(gh api "repos/${repo}/collaborators/${actor}/permission" --jq .permission)"
          case "${perm}" in
            admin|maintain|write) ;;
            *)
              echo "DENY: actor='${actor}' permission='${perm}'"
              exit 1
              ;;
          esac

          echo "ALLOW: actor='${actor}' association='${assoc}' permission='${perm}'"

      - name: Enable auto-merge (squash) via gh
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail

          pr_number="${{ github.event.pull_request.number }}"
          repo="${{ github.repository }}"

          echo "Enabling auto-merge for PR #${pr_number} in ${repo} (squash)"
          gh pr merge "${pr_number}" --repo "${repo}" --auto --squash
