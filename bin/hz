#!/bin/bash
set -euo pipefail

REPO_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
# shellcheck source=lib/cli_core.sh
. "${REPO_ROOT}/lib/cli_core.sh"
# shellcheck source=lib/recipe_loader.sh
. "${REPO_ROOT}/lib/recipe_loader.sh"
# shellcheck source=lib/inventory.sh
. "${REPO_ROOT}/lib/inventory.sh"

hz__parse_install_args() {
  # hz install <recipe> [--host=NAME|--host NAME]
  RECIPE_NAME=""
  HZ_HOST=""

  local a
  while [[ $# -gt 0 ]]; do
    a="$1"
    case "$a" in
      --host=*)
        HZ_HOST="${a#--host=}"
        shift
        ;;
      --host)
        shift
        HZ_HOST="${1:-}"
        shift || true
        ;;
      --)
        shift
        break
        ;;
      -*)
        hz_log "ERROR" "unknown flag for install: ${a}"
        return 1
        ;;
      *)
        if [[ -z "$RECIPE_NAME" ]]; then
          RECIPE_NAME="$a"
          shift
        else
          hz_log "ERROR" "unexpected extra arg for install: ${a}"
          return 1
        fi
        ;;
    esac
  done

  [[ -n "$RECIPE_NAME" ]] || return 1
  return 0
}

main() {
  local cmd="${1:-}"

  case "${cmd}" in
    ""|help|-h|--help)
      hz_usage
      return 0
      ;;
    version|--version)
      hz_read_version
      return 0
      ;;
    check)
      shift || true
      hz_run_check
      return $?
      ;;
    install)
      shift || true
      if ! hz__parse_install_args "$@"; then
        hz_usage
        return 1
      fi
      export HZ_HOST
      hz_recipe_install "${RECIPE_NAME}"
      return $?
      ;;
    recipe)
      shift || true
      case "${1:-}" in
        list)
          hz_list_targets "recipes"
          return 0
          ;;
        "")
          hz_usage
          return 1
          ;;
        *)
          [[ $# -ge 2 ]] || { hz_usage; return 1; }
          hz_run_target "recipes" "$1" "$2"
          return $?
          ;;
      esac
      ;;
    module)
      shift || true
      case "${1:-}" in
        list)
          hz_list_targets "modules"
          return 0
          ;;
        "")
          hz_usage
          return 1
          ;;
        *)
          [[ $# -ge 2 ]] || { hz_usage; return 1; }
          hz_run_target "modules" "$1" "$2"
          return $?
          ;;
      esac
      ;;
    *)
      hz_log "ERROR" "invalid subcommand: ${cmd}"
      hz_usage
      return 1
      ;;
  esac
}

main "$@"
