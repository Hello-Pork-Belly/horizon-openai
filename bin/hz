#!/bin/bash
set -euo pipefail

REPO_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"

# shellcheck source=lib/logging.sh
. "${REPO_ROOT}/lib/logging.sh"
# shellcheck source=lib/cli_core.sh
. "${REPO_ROOT}/lib/cli_core.sh"
# shellcheck source=lib/recipe_loader.sh
. "${REPO_ROOT}/lib/recipe_loader.sh"
# shellcheck source=lib/inventory.sh
. "${REPO_ROOT}/lib/inventory.sh"

hz__apply_global_flags() {
  # Scan argv; remove -v/-q; keep others in ARGS_OUT.
  # Verbose wins over quiet only if it appears later (last wins).
  ARGS_OUT=()
  local a
  for a in "$@"; do
    case "$a" in
      -v|--verbose) LOG_LEVEL="DEBUG"; HZ_DEBUG="1" ;;
      -q|--quiet) LOG_LEVEL="ERROR" ;;
      *) ARGS_OUT+=("$a") ;;
    esac
  done
  export LOG_LEVEL
  export HZ_DEBUG="${HZ_DEBUG:-0}"
}

hz__parse_install_args() {
  RECIPE_NAME=""
  HZ_HOST=""
  local a
  while [[ $# -gt 0 ]]; do
    a="$1"
    case "$a" in
      --host=*) HZ_HOST="${a#--host=}"; shift ;;
      --host) shift; HZ_HOST="${1:-}"; shift || true ;;
      --) shift; break ;;
      -*) log_error "unknown flag for install: ${a}"; return 1 ;;
      *)
        if [[ -z "$RECIPE_NAME" ]]; then
          RECIPE_NAME="$a"
        else
          log_error "unexpected extra arg for install: ${a}"
          return 1
        fi
        shift
        ;;
    esac
  done
  [[ -n "$RECIPE_NAME" ]] || return 1
  return 0
}

main() {
  hz__apply_global_flags "$@"
  set -- "${ARGS_OUT[@]}"

  local cmd="${1:-}"
  case "${cmd}" in
    ""|help|-h|--help)
      hz_usage
      return 0
      ;;
    version|--version)
      hz_read_version
      return 0
      ;;
    check)
      shift || true
      hz_run_check
      return $?
      ;;
    diagnose|doctor)
      shift || true
      exec bash "${REPO_ROOT}/tools/diagnostics/run.sh" "$@"
      ;;
    ping)
      # Usage: hz ping --target user@host|alias
      shift || true
      target=""
      while [[ $# -gt 0 ]]; do
        case "$1" in
          --target) target="${2:-}"; shift 2 ;;
          --target=*) target="${1#*=}"; shift ;;
          -h|--help)
            echo "Usage: hz ping --target user@host|alias"
            exit 0
            ;;
          *)
            echo "Unknown argument for ping: $1" >&2
            echo "Usage: hz ping --target user@host|alias" >&2
            exit 1
            ;;
        esac
      done

      if [[ -z "${target}" ]]; then
        echo "ping: missing --target" >&2
        echo "Usage: hz ping --target user@host|alias" >&2
        exit 1
      fi

      # Resolve alias via inventory (if exists)
      if declare -F inventory_resolve_target >/dev/null 2>&1; then
        if ! inventory_resolve_target "${target}"; then
          exit 1
        fi
        target="${HZ_RESOLVED_TARGET:-$target}"
      fi

      # Ensure transport is loaded (cli_core should have sourced it)
      if ! command -v ssh_test >/dev/null 2>&1; then
        echo "ping: ssh transport not available (ssh_test not found)" >&2
        exit 1
      fi

      log_info "ping: testing ssh connectivity to target=${target}"
      if ssh_test "${target}"; then
        log_info "ping: ok"
        exit 0
      else
        rc=$?
        log_error "ping: failed (rc=${rc})"
        exit "${rc}"
      fi
      ;;
    install)
      shift || true
      if ! hz__parse_install_args "$@"; then
        hz_usage
        return 1
      fi
      export HZ_HOST
      hz_recipe_install "${RECIPE_NAME}"
      return $?
      ;;
    recipe)
      shift || true
      case "${1:-}" in
        list) hz_list_targets "recipes"; return 0 ;;
        "") hz_usage; return 1 ;;
        *)
          [[ $# -ge 2 ]] || { hz_usage; return 1; }
          hz_run_target "recipes" "$1" "$2"
          return $?
          ;;
      esac
      ;;
    module)
      shift || true
      case "${1:-}" in
        list) hz_list_targets "modules"; return 0 ;;
        "") hz_usage; return 1 ;;
        *)
          [[ $# -ge 2 ]] || { hz_usage; return 1; }
          hz_run_target "modules" "$1" "$2"
          return $?
          ;;
      esac
      ;;
    *)
      log_error "invalid subcommand: ${cmd}"
      hz_usage
      return 1
      ;;
  esac
}

main "$@"
