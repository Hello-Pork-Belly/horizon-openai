#!/bin/bash
set -euo pipefail

REPO_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
# shellcheck source=lib/logging.sh
. "${REPO_ROOT}/lib/logging.sh"
# shellcheck source=lib/cli_core.sh
. "${REPO_ROOT}/lib/cli_core.sh"
# shellcheck source=lib/recipe_loader.sh
. "${REPO_ROOT}/lib/recipe_loader.sh"
# shellcheck source=lib/inventory.sh
. "${REPO_ROOT}/lib/inventory.sh"

hz__apply_global_flags() {
  # Scan argv; remove -v/-q; keep others in ARGS_OUT.
  # Verbose wins over quiet only if it appears later (last wins).
  ARGS_OUT=()
  local a
  for a in "$@"; do
    case "$a" in
      -v|--verbose)
        LOG_LEVEL="DEBUG"
        HZ_DEBUG="1"
        ;;
      -q|--quiet)
        LOG_LEVEL="ERROR"
        ;;
      *)
        ARGS_OUT+=("$a")
        ;;
    esac
  done

  export LOG_LEVEL
  export HZ_DEBUG="${HZ_DEBUG:-0}"
}

hz__parse_install_args() {
  RECIPE_NAME=""
  HZ_HOST=""

  local a
  while [[ $# -gt 0 ]]; do
    a="$1"
    case "$a" in
      --host=*)
        HZ_HOST="${a#--host=}"
        shift
        ;;
      --host)
        shift
        HZ_HOST="${1:-}"
        shift || true
        ;;
      --)
        shift
        break
        ;;
      -*)
        log_error "unknown flag for install: ${a}"
        return 1
        ;;
      *)
        if [[ -z "$RECIPE_NAME" ]]; then
          RECIPE_NAME="$a"
        else
          log_error "unexpected extra arg for install: ${a}"
          return 1
        fi
        shift
        ;;
    esac
  done

  [[ -n "$RECIPE_NAME" ]] || return 1
  return 0
}

main() {
  hz__apply_global_flags "$@"
  set -- "${ARGS_OUT[@]}"

  local cmd="${1:-}"

  case "${cmd}" in
    ""|help|-h|--help)
      hz_usage
      return 0
      ;;
    version|--version)
      hz_read_version
      return 0
      ;;
    check)
      shift || true
      hz_run_check
      return $?
      ;;
    install)
      shift || true
      if ! hz__parse_install_args "$@"; then
        hz_usage
        return 1
      fi
      export HZ_HOST
      hz_recipe_install "${RECIPE_NAME}"
      return $?
      ;;
    recipe)
      shift || true
      case "${1:-}" in
        list)
          hz_list_targets "recipes"
          return 0
          ;;
        "")
          hz_usage
          return 1
          ;;
        *)
          [[ $# -ge 2 ]] || { hz_usage; return 1; }
          hz_run_target "recipes" "$1" "$2"
          return $?
          ;;
      esac
      ;;
    module)
      shift || true
      case "${1:-}" in
        list)
          hz_list_targets "modules"
          return 0
          ;;
        "")
          hz_usage
          return 1
          ;;
        *)
          [[ $# -ge 2 ]] || { hz_usage; return 1; }
          hz_run_target "modules" "$1" "$2"
          return $?
          ;;
      esac
      ;;
    *)
      log_error "invalid subcommand: ${cmd}"
      hz_usage
      return 1
      ;;
  esac
}

main "$@"
